name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      - uses: actions/checkout@v2
      - name: Install requirements
        run: |
          ls -la $ANDROID_HOME
          ls -la $ANDROID_HOME/cmdline-tools
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
          sdkmanager emulator
          apt-fast -y install \
          libdbus-glib-1-dev \
          libdrm-dev \
          libgtk-3-dev \
          libgtk2.0-dev \
          libpango1.0-dev \
          libpulse-dev \
          libx11-xcb-dev \
          nasm
          rustup target add aarch64-linux-android
          sdkmanager emulator
      - name: Run build script
        run: |
          sed -i -e 's/"r21d"/"r21e"/' python/mozboot/mozboot/android.py
          ./mach create-mach-environment
          ./mach build binaries && ./mach gradle geckoview:publishWithGeckoBinariesDebugPublicationToMavenRepository
